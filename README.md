ArduinoGCodeParserFromSDforConcrete3DPrinter_ModbusRTU

Микропроцессорная система управления бетонным платформенным 3D-принтером на базе Arduino Mega. Проект читает G-код с SD-карты, управляет движением платформы (X, Y, Z) через двигатели, отслеживает их положение с помощью датчиков Холла по протоколу Modbus и контролирует подачу бетона.
Возможности

Чтение G-кода: Парсинг G-кода с SD-карты (файл gcode.txt).
Управление движением:
Перемещение по осям X, Y (шаговые двигатели).
Подъём/опускание платформы по оси Z (четыре двигателя).
Хоминг (G28) с использованием датчиков Холла и концевых датчиков.


Датчики Холла: Отслеживание оборотов двигателей через Modbus (RS485).
Подача бетона: Управление двигателем подачи бетона (M3 — включить, M5 — выключить).
Состояния принтера:
IDLE: Ожидание.
PRINTING: Печать.
PAUSED: Пауза.
EMERGENCY: Аварийный режим (например, при сбое Modbus или таймауте).


Логирование: Вывод состояния и ошибок в Serial (115200 бод).

Требования

Аппаратное обеспечение:
Плата: Arduino Mega 2560.
SD-карта: Для хранения G-кода (подключена через SPI, пин CS — см. pins_arduino.h).
Датчики Холла: Для отслеживания оборотов двигателей (4 штуки, по одному на двигатель Z).
RS485-модуль: Для связи по Modbus (пины RX, TX, DE/RE — см. pins_arduino.h).
Шаговые двигатели: Для осей X, Y (пины STEP, DIR — см. pins_arduino.h).
Реле (SSR): Для управления двигателями Z и подачей бетона (пины SSR — см. pins_arduino.h).


Программное обеспечение:
Arduino IDE: 1.8.19 или выше.
Библиотеки:
SPI (встроена в Arduino).
SD (встроена в Arduino).
ModbusMaster (установить через Library Manager).
SoftwareSerial (встроена в Arduino).




G-код: Файл gcode.txt на SD-карте с командами (G0, G1, G28, M3, M5).

Установка

Подготовьте оборудование:

Подключите SD-карту к Arduino Mega через SPI (пин CS, обычно 53).
Подключите RS485-модуль (пины RX, TX, DE/RE — см. pins_arduino.h).
Подключите шаговые двигатели (X, Y) и реле для двигателей Z и подачи бетона.
Убедитесь, что датчики Холла и концевые датчики подключены к каждому двигателю Z.


Склонируйте репозиторий:
git clone https://github.com/<ваш-username>/Concrete3DPrinter.git
cd Concrete3DPrinter


Установите Arduino IDE:

Скачайте с arduino.cc.
Установите и откройте IDE.


Установите библиотеку ModbusMaster:

В Arduino IDE: Sketch > Include Library > Manage Libraries.
Найдите и установите ModbusMaster.


Создайте G-код:

Создайте файл gcode.txt на SD-карте с командами, например:G28
G1 X10 Y10 Z100 F100
M3
G1 X20 Y20 Z100 F100
M5


Вставьте SD-карту в модуль.


Загрузите код:

Откройте gCodeParser_SD.ino в Arduino IDE.
Подключите Arduino Mega через USB.
Выберите: Tools > Board > Arduino Mega or Mega 2560.
Нажмите Upload.



Использование

Запуск принтера:

После загрузки кода принтер инициализируется и переходит в состояние IDLE.
Serial Monitor (115200 бод) покажет: Принтер инициализирован.


Печать:

Принтер автоматически переходит в PRINTING и начинает читать gcode.txt.
Поддерживаемые команды:
G0/G1: Линейное перемещение (X, Y, Z, F — скорость).
G28: Хоминг (X=0, Y=0, Z к концевым датчикам).
M3: Включить подачу бетона (с задержкой 1 сек).
M5: Выключить подачу бетона.


Логи в Serial Monitor показывают выполняемые команды и позиции.


Мониторинг:

Откройте Serial Monitor (Tools > Serial Monitor, 115200 бод).
Следите за:
Положением двигателей (через датчики Холла).
Срабатыванием концевых датчиков.
Состоянием принтера (PRINTING, EMERGENCY).
Ошибками (например, таймаут Modbus).




Остановка:

При завершении G-кода или ошибке (например, сбой Modbus) принтер переходит в EMERGENCY.
Все двигатели останавливаются, подача бетона выключается.



Структура проекта

gCodeParser_SD.ino: Основной скетч, управляет состояниями принтера и выполнением G-кода.
gcode_parser.cpp/h: Парсинг G-кода с SD-карты (команды G0, G1, G28, M3, M5).
motion_control.cpp/h: Управление движением (X, Y, Z) и подачей бетона.
hall_sensor.cpp/h: Обработка данных с датчиков Холла через Modbus.
modbus_config.cpp/h: Настройка связи по RS485 (Modbus).
motor_control.cpp/h: Управление двигателями Z и пусковыми конденсаторами.
printer_state.cpp/h: Управление состояниями принтера (IDLE, PRINTING, PAUSED, EMERGENCY).
sd_card.cpp/h: Чтение G-кода с SD-карты.
pins_arduino.h: Определение пинов для Arduino Mega.

Ограничения

Безопасность: Нет поддержки экстренной остановки через аппаратную кнопку.
Modbus: Сбой связи (2 неудачных запроса) переводит принтер в EMERGENCY.
Таймауты:
Хоминг: 30 секунд.
Движение по Z: 30 секунд.


G-код: Поддерживаются только G0, G1, G28, M3, M5.
SD-карта: Требуется файл gcode.txt, иначе принтер не запустится.
Аппаратное обеспечение: Требует точной настройки пинов и датчиков (см. pins_arduino.h).

Устранение неполадок

SD-карта не читается:
Проверьте подключение (пин CS, обычно 53).
Убедитесь, что gcode.txt существует.
Проверьте логи в Serial Monitor.


Modbus не отвечает:
Проверьте подключение RS485 (пины RX, TX, DE/RE).
Убедитесь, что скорость Modbus — 38400 бод.
Проверьте ID слейвов (1–4).


Двигатели не работают:
Проверьте реле (SSR) и пины в pins_arduino.h.
Убедитесь, что пусковые конденсаторы включаются (STARTCAP_OFF_TIME = 500 мс).


Хоминг не завершается:
Проверьте концевые датчики (значение EndS в Serial Monitor).
Убедитесь, что датчики Холла возвращают данные (Count и Pos).
